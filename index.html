<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viral Space Defender</title>
    <!-- 10x Improvement: Added TON Connect and Telegram WebApp scripts -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0A0A2A, #1C1C4C);
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #FFD700;
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background: #000;
            border: 5px solid #00FFFF;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            overflow: hidden;
        }
        #canvas {
            display: block;
            background: transparent;
        }
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        #logo {
            width: 300px;
            height: 300px;
        }
        #start-button {
            background: #FF00FF;
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            margin-top: 20px;
            transition: transform 0.3s;
        }
        #start-button:hover {
            transform: scale(1.1);
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #00FFFF;
        }
        #score, #level, #health {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
        }
        #shop-button {
            background: #FF4500;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }
        #shop-button:hover {
            transform: scale(1.1);
        }
        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 20px #00FFFF;
            display: none;
            z-index: 15;
            width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        #shop h2 {
            text-align: center;
            color: #00FFFF;
            text-shadow: 0 0 10px #00FFFF;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid #00FFFF;
        }
        .shop-item span {
            flex: 1;
        }
        .shop-item button {
            background: #32CD32;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 5px;
        }
        .shop-item button:hover {
            background: #228B22;
        }
        .shop-item button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        #close-shop {
            display: block;
            margin: 15px auto 0;
            background: #FF0000;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            color: #fff;
            font-size: 48px;
            text-shadow: 0 0 10px #000;
        }
        #restart-button {
            background: #FFD700;
            color: #000;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            margin-top: 20px;
        }
        /* 10x Improvement: Added TON Connect button container */
        #ton-connect-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 30;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="title-screen">
            <svg id="logo" viewBox="0 0 100 100">
                <!-- Inspired by the colorful geometric logos in the drawings -->
                <polygon points="50,10 90,30 90,70 50,90 10,70 10,30" fill="none" stroke="#00FFFF" stroke-width="3"/>
                <polygon points="50,20 80,35 80,65 50,80 20,65 20,35" fill="none" stroke="#FF00FF" stroke-width="3"/>
                <text x="50" y="55" font-size="30" text-anchor="middle" fill="#FFD700" font-weight="bold">VSD</text>
                <line x1="30" y1="40" x2="70" y2="60" stroke="#FFFF00" stroke-width="2"/>
                <line x1="30" y1="60" x2="70" y2="40" stroke="#FFFF00" stroke-width="2"/>
            </svg>
            <h1 style="text-shadow: 0 0 10px #00FFFF;">Viral Space Defender</h1>
            <button id="start-button">Start Mission</button>
        </div>
        <div id="ui" style="display: none;">
            <div id="score">Score: 0</div>
            <div id="level">Level: 1</div>
            <div id="health">Health: 3</div>
            <button id="shop-button">Upgrades</button>
        </div>
        <div id="shop">
            <h2>Upgrade Station</h2>
            <div class="shop-item">
                <span>Auto-Blaster (+1/sec) - Cost: 50 Score / 0.1 TON</span>
                <button id="buy-auto">Score</button>
                <button id="buy-auto-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Score Multiplier x2 - Cost: 100 Score / 0.2 TON</span>
                <button id="buy-multi">Score</button>
                <button id="buy-multi-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Super Laser (x2 damage) - Cost: 200 Score / 0.5 TON</span>
                <button id="buy-super">Score</button>
                <button id="buy-super-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Speed Boost (+20% speed) - Cost: 150 Score / 0.3 TON</span>
                <button id="buy-speed">Score</button>
                <button id="buy-speed-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Shield Upgrade (+1 health) - Cost: 300 Score / 0.6 TON</span>
                <button id="buy-health">Score</button>
                <button id="buy-health-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Magnet Field (attract enemies) - Cost: 250 Score / 0.5 TON</span>
                <button id="buy-magnet">Score</button>
                <button id="buy-magnet-ton">TON</button>
            </div>
            <button id="close-shop">Exit Station</button>
        </div>
        <div id="game-over">
            <h1>Mission Failed</h1>
            <p>Final Score: <span id="final-score"></span></p>
            <button id="restart-button">Retry Mission</button>
        </div>
        <!-- 10x Improvement: TON Connect button -->
        <div id="ton-connect-container">
            <div id="ton-connect"></div>
        </div>
    </div>
    <audio id="bg-music" loop>
        <source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>
    <audio id="hit-sound">
        <source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>
    <audio id="level-up-sound">
        <source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg">
    </audio>
    <script>
        // --- 10x Improvement: TON Connect & Telegram WebApp Integration ---
        const tonConnectUI = new TONCONNECT_UI.TonConnectUI({
            manifestUrl: 'https://marcone1983.github.io/Viral-space-Defender/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        // User's Wallet for payments
        const devWallet = 'UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR';

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const healthEl = document.getElementById('health');
        const shopButton = document.getElementById('shop-button');
        const shop = document.getElementById('shop');
        const closeShop = document.getElementById('close-shop');
        const buyAuto = document.getElementById('buy-auto');
        const buyMulti = document.getElementById('buy-multi');
        const buySuper = document.getElementById('buy-super');
        const buySpeed = document.getElementById('buy-speed');
        const buyHealth = document.getElementById('buy-health');
        const buyMagnet = document.getElementById('buy-magnet');
        const titleScreen = document.getElementById('title-screen');
        const startButton = document.getElementById('start-button');
        const gameOver = document.getElementById('game-over');
        const finalScore = document.getElementById('final-score');
        const restartButton = document.getElementById('restart-button');
        const bgMusic = document.getElementById('bg-music');
        const hitSound = document.getElementById('hit-sound');
        const levelUpSound = document.getElementById('level-up-sound');

        let score = 0;
        let level = 1;
        let health = 3;
        let playerSpeed = 15;
        let autoClickers = 0;
        let multiplier = 1;
        let superClick = false;
        let magnet = false;
        let superBought = false;
        let speedLevel = 0;
        let healthLevel = 0;
        let magnetBought = false;
        let gameStarted = false;
        let gamePaused = false;
        let nextSpawnTime = 0;
        let stars = [];
        let powerUps = [];
        let enemies = [];
        let particles = [];
        let bossActive = false;
        let boss = null;

        // Original 2D Drawing Data
        let player = { x: 400, y: 500, size: 50, color: '#00FFFF', armorColor: '#FFD700', helmetColor: '#FF00FF' };

        // 10x Improvement: Dynamic Starfield
        for (let i = 0; i < 100; i++) {
            stars.push({
                x: Math.random() * 800,
                y: Math.random() * 600,
                size: Math.random() * 2 + 1,
                speed: Math.random() * 0.5 + 0.1
            });
        }

        function drawBackground() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            stars.forEach(star => {
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
                star.y += star.speed;
                if (star.y > 600) star.y = 0;
            });
        }

        // 10x Improvement: Restored original elaborate ship design
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            // Inspired by the drawings: elaborate ship design
            ctx.fillStyle = player.color;
            ctx.beginPath();
            ctx.ellipse(0, 0, 20, 30, 0, 0, Math.PI * 2);
            ctx.fill();
            // Armor wings
            ctx.fillStyle = player.armorColor;
            ctx.beginPath();
            ctx.moveTo(-25, -10); ctx.lineTo(-35, 10); ctx.lineTo(-25, 20); ctx.fill();
            ctx.beginPath();
            ctx.moveTo(25, -10); ctx.lineTo(35, 10); ctx.lineTo(25, 20); ctx.fill();
            // Helmet
            ctx.fillStyle = player.helmetColor;
            ctx.beginPath();
            ctx.arc(0, -25, 15, 0, Math.PI * 2);
            ctx.fill();
            // Thruster effect
            if (Math.random() > 0.5) {
                ctx.fillStyle = '#FF4500';
                ctx.beginPath();
                ctx.moveTo(-10, 30); ctx.lineTo(0, 50); ctx.lineTo(10, 30); ctx.fill();
            }
            ctx.restore();
        }

        function createEnemy() {
            const types = ['drone', 'fighter', 'bomber'];
            const type = types[Math.floor(Math.random() * types.length)];
            let size = 30, speed = 2 + level * 0.3, color = '#FF0000', health = 1;
            if (type === 'fighter') { size = 25; speed += 1; color = '#FF4500'; }
            else if (type === 'bomber') { size = 40; speed -= 0.5; color = '#8B0000'; health = 2; }
            enemies.push({ x: Math.random() * 750 + 25, y: -50, size, speed, color, type, health, angle: 0, zigZag: Math.random() > 0.5, zigDir: 1 });
        }

        function updateEnemies(dt) {
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                enemy.y += enemy.speed * dt * 60;
                if (enemy.zigZag) {
                    enemy.x += Math.sin(enemy.angle) * 5 * enemy.zigDir;
                    enemy.angle += 0.1;
                }
                // 10x Improvement: Magnet effect
                if (magnet) {
                    const dx = player.x - enemy.x;
                    const dy = player.y - enemy.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 200) { enemy.x += (dx / dist) * 2; enemy.y += (dy / dist) * 2; }
                }
                if (enemy.y > 650) { health--; updateHealth(); enemies.splice(i, 1); continue; }
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < player.size / 2 + enemy.size / 2) {
                    health--; updateHealth();
                    createParticles(enemy.x, enemy.y, 15, enemy.color);
                    enemies.splice(i, 1);
                }
            }
        }

        function drawEnemies() {
            enemies.forEach(enemy => {
                ctx.save();
                ctx.translate(enemy.x, enemy.y);
                ctx.fillStyle = enemy.color;
                if (enemy.type === 'drone') { ctx.beginPath(); ctx.arc(0, 0, enemy.size / 2, 0, Math.PI * 2); ctx.fill(); }
                else if (enemy.type === 'fighter') { ctx.beginPath(); ctx.moveTo(0, -enemy.size / 2); ctx.lineTo(-enemy.size / 2, enemy.size / 2); ctx.lineTo(enemy.size / 2, enemy.size / 2); ctx.fill(); }
                else if (enemy.type === 'bomber') { ctx.fillRect(-enemy.size / 2, -enemy.size / 4, enemy.size, enemy.size / 2); }
                ctx.restore();
            });
        }

        // 10x Improvement: Advanced Boss Battles
        function createBoss() {
            boss = { x: 400, y: 100, size: 150, speed: 2, health: 20 + level * 5, maxHealth: 20 + level * 5, color: '#4B0082', angle: 0, dir: 1 };
            bossActive = true;
        }

        function updateBoss(dt) {
            boss.x += Math.sin(boss.angle) * boss.speed * boss.dir * dt * 60;
            boss.angle += 0.02;
            if (boss.x < 100 || boss.x > 700) boss.dir *= -1;
            const dx = player.x - boss.x;
            const dy = player.y - boss.y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            if (dist < player.size / 2 + boss.size / 2) { health--; updateHealth(); }
        }

        function drawBoss() {
            ctx.save();
            ctx.translate(boss.x, boss.y);
            ctx.fillStyle = boss.color;
            ctx.beginPath(); ctx.moveTo(0, -boss.size / 2); ctx.lineTo(-boss.size / 2, boss.size / 2); ctx.lineTo(boss.size / 2, boss.size / 2); ctx.fill();
            ctx.fillStyle = '#FF0000'; ctx.beginPath(); ctx.arc(-20, 0, 10, 0, Math.PI * 2); ctx.fill();
            ctx.beginPath(); ctx.arc(20, 0, 10, 0, Math.PI * 2); ctx.fill();
            ctx.fillStyle = '#FF0000'; ctx.fillRect(-boss.size / 2, -boss.size / 2 - 10, boss.size, 5);
            ctx.fillStyle = '#00FF00'; ctx.fillRect(-boss.size / 2, -boss.size / 2 - 10, boss.size * (boss.health / boss.maxHealth), 5);
            ctx.restore();
        }

        // 10x Improvement: Particle System
        function createParticles(x, y, count = 10, color = '#FFD700') {
            for (let i = 0; i < count; i++) {
                particles.push({ x, y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10, life: 1, color });
            }
        }

        function updateParticles(dt) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
            });
            ctx.globalAlpha = 1;
        }

        function updateScore() {
            const newLevel = Math.floor(score / 500) + 1;
            if (newLevel > level) { level = newLevel; levelUpSound.play(); if (level % 5 === 0) createBoss(); }
            scoreEl.textContent = `Score: ${Math.floor(score)}`;
            levelEl.textContent = `Level: ${level}`;
        }

        function updateHealth() {
            healthEl.textContent = `Health: ${health}`;
            if (health <= 0) showGameOver();
        }

        function showGameOver() {
            gamePaused = true;
            finalScore.textContent = Math.floor(score);
            gameOver.style.display = 'flex';
            bgMusic.pause();
        }

        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!gameStarted || gamePaused) return requestAnimationFrame(gameLoop);
            const dt = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            const now = Date.now();
            if (now > nextSpawnTime && !bossActive) { createEnemy(); nextSpawnTime = now + Math.max(200, 800 - level * 30); }
            drawBackground();
            drawPlayer();
            updateEnemies(dt);
            drawEnemies();
            if (bossActive) {
                updateBoss(dt); drawBoss();
                if (boss.health <= 0) { bossActive = false; score += 1000 * multiplier; createParticles(boss.x, boss.y, 50); updateScore(); }
            }
            updateParticles(dt);
            drawParticles();
            requestAnimationFrame(gameLoop);
        }

        // Controls
        const keys = {};
        document.addEventListener('keydown', e => keys[e.key] = true);
        document.addEventListener('keyup', e => keys[e.key] = false);
        setInterval(() => {
            if (!gameStarted || gamePaused) return;
            if (keys['ArrowLeft'] || keys['a']) player.x -= playerSpeed;
            if (keys['ArrowRight'] || keys['d']) player.x += playerSpeed;
            if (keys['ArrowUp'] || keys['w']) player.y -= playerSpeed;
            if (keys['ArrowDown'] || keys['s']) player.y += playerSpeed;
            player.x = Math.max(25, Math.min(775, player.x));
            player.y = Math.max(25, Math.min(575, player.y));
        }, 16);

        canvas.addEventListener('click', e => {
            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            if (bossActive && Math.hypot(clickX - boss.x, clickY - boss.y) < boss.size / 2) {
                boss.health -= superClick ? 2 : 1;
                createParticles(boss.x, boss.y, 10); hitSound.play();
                return;
            }
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                if (Math.hypot(clickX - enemy.x, clickY - enemy.y) < enemy.size / 2) {
                    enemy.health -= superClick ? 2 : 1;
                    if (enemy.health <= 0) { score += (10 + level * 5) * multiplier; createParticles(enemy.x, enemy.y, 10); enemies.splice(i, 1); updateScore(); }
                    break;
                }
            }
        });

        // 10x Improvement: TON Monetization Logic
        async function buyWithTon(amountNano, action) {
            try {
                const tx = { validUntil: Math.floor(Date.now() / 1000) + 60, messages: [{ address: devWallet, amount: amountNano.toString() }] };
                await tonConnectUI.sendTransaction(tx);
                action(); telegram.showAlert('Transaction successful!');
            } catch (e) { telegram.showAlert('Transaction failed: ' + e.message); }
        }

        document.getElementById('buy-auto-ton').onclick = () => buyWithTon(100000000, () => { autoClickers++; updateScore(); });
        document.getElementById('buy-multi-ton').onclick = () => buyWithTon(200000000, () => { multiplier *= 2; updateScore(); });
        document.getElementById('buy-super-ton').onclick = () => buyWithTon(500000000, () => { superClick = true; superBought = true; updateScore(); });
        document.getElementById('buy-speed-ton').onclick = () => buyWithTon(300000000, () => { playerSpeed += 3; speedLevel++; updateScore(); });
        document.getElementById('buy-health-ton').onclick = () => buyWithTon(600000000, () => { health++; healthLevel++; updateHealth(); });
        document.getElementById('buy-magnet-ton').onclick = () => buyWithTon(500000000, () => { magnet = true; magnetBought = true; updateScore(); });

        buyAuto.onclick = () => { if (score >= 50) { score -= 50; autoClickers++; updateScore(); } };
        buyMulti.onclick = () => { if (score >= 100) { score -= 100; multiplier *= 2; updateScore(); } };
        buySuper.onclick = () => { if (!superBought && score >= 200) { score -= 200; superClick = true; superBought = true; updateScore(); } };
        buySpeed.onclick = () => { if (score >= 150 && speedLevel < 5) { score -= 150; playerSpeed += 3; speedLevel++; updateScore(); } };
        buyHealth.onclick = () => { if (score >= 300 && healthLevel < 3) { score -= 300; health++; healthLevel++; updateHealth(); } };
        buyMagnet.onclick = () => { if (!magnetBought && score >= 250) { score -= 250; magnet = true; magnetBought = true; updateScore(); } };

        shopButton.onclick = () => { gamePaused = true; shop.style.display = 'block'; };
        closeShop.onclick = () => { gamePaused = false; shop.style.display = 'none'; requestAnimationFrame(gameLoop); };
        startButton.onclick = () => { titleScreen.style.display = 'none'; document.getElementById('ui').style.display = 'flex'; gameStarted = true; lastTime = performance.now(); bgMusic.play(); nextSpawnTime = Date.now() + 500; requestAnimationFrame(gameLoop); };
        restartButton.onclick = () => location.reload();

        setInterval(() => { if (gameStarted && !gamePaused) { score += autoClickers * multiplier; updateScore(); } }, 1000);
        
        // Initial state
        updateScore();
        updateHealth();
    </script>
</body>
</html>
