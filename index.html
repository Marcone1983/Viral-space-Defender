<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viral Space Defender - Ultimate Edition</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        :root {
            --neon-cyan: #00FFFF;
            --neon-magenta: #FF00FF;
            --neon-yellow: #FFFF00;
            --space-dark: #0A0A2A;
        }
        body {
            margin: 0;
            padding: 0;
            background: #000;
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #FFD700;
            touch-action: none;
        }
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 800px;
            max-height: 600px;
            background: #000;
            border: 4px solid var(--neon-cyan);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.3);
            overflow: hidden;
        }
        #canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: transparent;
        }
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }
        #logo {
            width: 40vmin;
            height: 40vmin;
            max-width: 250px;
            max-height: 250px;
            filter: drop-shadow(0 0 15px var(--neon-cyan));
            margin-bottom: 20px;
        }
        #start-button {
            background: linear-gradient(45deg, var(--neon-magenta), #800080);
            color: #fff;
            padding: 20px 40px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 28px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 20px var(--neon-magenta);
            transition: all 0.3s;
            z-index: 110;
        }
        #start-button:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px var(--neon-magenta);
        }
        #ui {
            position: absolute;
            top: 15px;
            left: 15px;
            right: 15px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            pointer-events: none;
        }
        .ui-box {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--neon-cyan);
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 0 5px var(--neon-cyan);
            pointer-events: auto;
        }
        #shop-button {
            background: #FF4500;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            pointer-events: auto;
        }
        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(10, 10, 42, 0.98);
            padding: 25px;
            border-radius: 20px;
            border: 2px solid var(--neon-cyan);
            box-shadow: 0 0 50px var(--neon-cyan);
            display: none;
            z-index: 200;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        .shop-item span { flex: 1; font-size: 13px; margin-right: 10px; }
        .btn-group { display: flex; flex-direction: column; gap: 5px; }
        .btn-group button {
            background: #32CD32;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
        }
        .btn-group button:disabled { background: #444; cursor: not-allowed; }
        #close-shop {
            display: block;
            margin: 15px auto 0;
            background: #FF0000;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            color: #fff;
        }
        #restart-button {
            background: var(--neon-yellow);
            color: #000;
            padding: 15px 40px;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 24px;
            font-weight: bold;
            margin-top: 20px;
        }
        #wallet-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 150;
        }
        #joystick {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: none;
            z-index: 60;
        }
        #joystick-knob {
            position: absolute;
            width: 40px;
            height: 40px;
            background: var(--neon-cyan);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 15px var(--neon-cyan);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas"></canvas>
        
        <div id="title-screen">
            <svg id="logo" viewBox="0 0 100 100">
                <polygon points="50,10 90,30 90,70 50,90 10,70 10,30" fill="none" stroke="#00FFFF" stroke-width="3"/>
                <polygon points="50,20 80,35 80,65 50,80 20,65 20,35" fill="none" stroke="#FF00FF" stroke-width="3"/>
                <text x="50" y="55" font-size="30" text-anchor="middle" fill="#FFD700" font-weight="bold">VSD</text>
            </svg>
            <h1 style="text-shadow: 0 0 15px var(--neon-cyan); font-size: 7vmin; margin: 10px 0;">VIRAL SPACE DEFENDER</h1>
            <p style="color: var(--neon-cyan); margin-bottom: 30px;">ULTIMATE EDITION</p>
            <button id="start-button">AVVIA MISSIONE</button>
        </div>

        <div id="ui">
            <div id="score" class="ui-box">Score: 0</div>
            <div id="level" class="ui-box">Level: 1</div>
            <div id="health" class="ui-box">Health: 3</div>
            <button id="shop-button">UPGRADES</button>
        </div>

        <div id="wallet-container">
            <div id="ton-connect"></div>
        </div>

        <div id="shop">
            <h2>STAZIONE UPGRADE</h2>
            <div class="shop-item">
                <span>Auto-Blaster (+1/sec)<br>50 Score / 0.1 TON</span>
                <div class="btn-group">
                    <button id="buy-auto">SCORE</button>
                    <button id="buy-auto-ton">TON</button>
                </div>
            </div>
            <div class="shop-item">
                <span>Moltiplicatore x2<br>100 Score / 0.2 TON</span>
                <div class="btn-group">
                    <button id="buy-multi">SCORE</button>
                    <button id="buy-multi-ton">TON</button>
                </div>
            </div>
            <div class="shop-item">
                <span>Super Laser (Danno x2)<br>200 Score / 0.5 TON</span>
                <div class="btn-group">
                    <button id="buy-super">SCORE</button>
                    <button id="buy-super-ton">TON</button>
                </div>
            </div>
            <div class="shop-item">
                <span>Boost Velocit√† (+20%)<br>150 Score / 0.3 TON</span>
                <div class="btn-group">
                    <button id="buy-speed">SCORE</button>
                    <button id="buy-speed-ton">TON</button>
                </div>
            </div>
            <div class="shop-item">
                <span>Scudo Extra (+1 Vita)<br>300 Score / 0.6 TON</span>
                <div class="btn-group">
                    <button id="buy-health">SCORE</button>
                    <button id="buy-health-ton">TON</button>
                </div>
            </div>
            <div class="shop-item">
                <span>Campo Magnetico<br>250 Score / 0.5 TON</span>
                <div class="btn-group">
                    <button id="buy-magnet">SCORE</button>
                    <button id="buy-magnet-ton">TON</button>
                </div>
            </div>
            <button id="close-shop">ESCI</button>
        </div>

        <div id="game-over">
            <h1>MISSIONE FALLITA</h1>
            <p style="font-size: 24px;">Punteggio: <span id="final-score">0</span></p>
            <button id="restart-button">RIPROVA</button>
        </div>

        <div id="joystick">
            <div id="joystick-knob"></div>
        </div>
    </div>

    <script>
        // --- GLOBALS ---
        const telegram = window.Telegram.WebApp;
        telegram.ready();
        telegram.expand();

        const devWallet = 'UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR';
        const tonConnectUI = new TONCONNECT_UI.TonConnectUI({
            manifestUrl: 'https://marcone1983.github.io/Viral-space-Defender/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const healthEl = document.getElementById('health');
        const shopEl = document.getElementById('shop');
        const joystickEl = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystick-knob');

        let score = 0, level = 1, health = 3;
        let playerSpeed = 8, autoClickers = 0, multiplier = 1;
        let superClick = false, magnet = false;
        let gameStarted = false, gamePaused = false, bossActive = false;
        let stars = [], enemies = [], bullets = [], particles = [];
        let boss = null, nextSpawnTime = 0, lastTime = 0;
        let logicalWidth = 800, logicalHeight = 600, scaleX = 1, scaleY = 1;
        let joystickActive = false, joystickTouchId = null, joystickCenterX = 0, joystickCenterY = 0;

        let player = { x: 400, y: 500, size: 50 };

        // --- INIT ---
        function init() {
            for (let i = 0; i < 60; i++) {
                stars.push({
                    x: Math.random() * logicalWidth,
                    y: Math.random() * logicalHeight,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 1 + 0.2
                });
            }
            resize();
            window.addEventListener('resize', resize);
            updateScore();
            updateHealth();
            requestAnimationFrame(gameLoop);
        }

        function resize() {
            const container = document.getElementById('game-container');
            const aspect = logicalWidth / logicalHeight;
            let w = window.innerWidth, h = window.innerHeight;
            if (w / h > aspect) w = h * aspect; else h = w / aspect;
            container.style.width = `${w}px`;
            container.style.height = `${h}px`;
            canvas.width = w; canvas.height = h;
            scaleX = w / logicalWidth; scaleY = h / logicalHeight;
        }

        // --- DRAWING ---
        function drawPlayer() {
            ctx.save();
            ctx.scale(scaleX, scaleY);
            ctx.translate(player.x, player.y);
            
            // Corpo
            ctx.fillStyle = '#00FFFF';
            ctx.beginPath(); ctx.ellipse(0, 0, 20, 30, 0, 0, Math.PI * 2); ctx.fill();
            
            // Armatura
            ctx.fillStyle = '#FFD700';
            ctx.beginPath(); ctx.moveTo(-25, -10); ctx.lineTo(-35, 10); ctx.lineTo(-25, 20); ctx.fill();
            ctx.beginPath(); ctx.moveTo(25, -10); ctx.lineTo(35, 10); ctx.lineTo(25, 20); ctx.fill();
            
            // Casco
            ctx.fillStyle = '#FF00FF';
            ctx.beginPath(); ctx.arc(0, -25, 15, 0, Math.PI * 2); ctx.fill();
            
            // Propulsore
            if (Math.random() > 0.3) {
                ctx.fillStyle = '#FF4500';
                ctx.beginPath(); ctx.moveTo(-10, 30); ctx.lineTo(0, 50); ctx.lineTo(10, 30); ctx.fill();
            }
            ctx.restore();
        }

        function drawEnemy(e) {
            ctx.save();
            ctx.scale(scaleX, scaleY);
            ctx.translate(e.x, e.y);
            ctx.fillStyle = e.color;
            if (e.type === 'drone') {
                ctx.beginPath(); ctx.arc(0, 0, e.size/2, 0, Math.PI*2); ctx.fill();
            } else if (e.type === 'fighter') {
                ctx.beginPath(); ctx.moveTo(0, -e.size/2); ctx.lineTo(-e.size/2, e.size/2); ctx.lineTo(e.size/2, e.size/2); ctx.fill();
            } else {
                ctx.fillRect(-e.size/2, -e.size/4, e.size, e.size/2);
            }
            ctx.restore();
        }

        function drawBoss() {
            if (!boss) return;
            ctx.save();
            ctx.scale(scaleX, scaleY);
            ctx.translate(boss.x, boss.y);
            ctx.fillStyle = '#4B0082';
            ctx.beginPath(); ctx.moveTo(0, -boss.size/2); ctx.lineTo(-boss.size/2, 0); ctx.lineTo(0, boss.size/2); ctx.lineTo(boss.size/2, 0); ctx.fill();
            ctx.strokeStyle = '#00FFFF'; ctx.lineWidth = 3; ctx.stroke();
            // Health bar
            ctx.fillStyle = '#333'; ctx.fillRect(-boss.size/2, -boss.size/2 - 20, boss.size, 10);
            ctx.fillStyle = '#00FF00'; ctx.fillRect(-boss.size/2, -boss.size/2 - 20, boss.size * (boss.health/boss.maxHealth), 10);
            ctx.restore();
        }

        // --- GAME LOGIC ---
        function createEnemy() {
            const types = ['drone', 'fighter', 'bomber'];
            const type = types[Math.floor(Math.random() * types.length)];
            let size = 40, speed = 2 + level * 0.2, color = '#FF3333', hp = 1;
            if (type === 'fighter') { speed += 1.5; color = '#FF8C00'; }
            if (type === 'bomber') { size = 60; speed -= 0.5; color = '#8B0000'; hp = 3; }
            enemies.push({ x: Math.random() * 700 + 50, y: -50, size, speed, type, color, health: hp });
        }

        function createBoss() {
            boss = { x: 400, y: 100, size: 150, speed: 2, health: 20 + level * 5, maxHealth: 20 + level * 5, dir: 1, angle: 0 };
            bossActive = true;
        }

        function update(dt) {
            if (!gameStarted || gamePaused) return;
            stars.forEach(s => { s.y += s.speed; if (s.y > logicalHeight) s.y = 0; });
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i]; e.y += e.speed;
                if (Math.hypot(player.x - e.x, player.y - e.y) < 40) { health--; updateHealth(); enemies.splice(i, 1); continue; }
                if (e.y > logicalHeight + 50) { health--; updateHealth(); enemies.splice(i, 1); }
            }
            if (bossActive && boss) {
                boss.x += Math.sin(boss.angle) * boss.speed * boss.dir; boss.angle += 0.02;
                if (boss.x < 100 || boss.x > 700) boss.dir *= -1;
                if (Math.random() < 0.02) bullets.push({ x: boss.x, y: boss.y + 50, speed: 5 });
            }
            for (let i = bullets.length - 1; i >= 0; i--) {
                let b = bullets[i]; b.y += b.speed;
                if (Math.hypot(player.x - b.x, player.y - b.y) < 25) { health--; updateHealth(); bullets.splice(i, 1); }
                if (b.y > 650) bullets.splice(i, 1);
            }
            particles.forEach((p, i) => { p.x += p.vx; p.y += p.vy; p.life -= 0.02; if (p.life <= 0) particles.splice(i, 1); });
            if (magnet) { enemies.forEach(e => { const dx = player.x - e.x, dy = player.y - e.y, d = Math.hypot(dx, dy); if (d < 200) { e.x += dx/d * 2; e.y += dy/d * 2; } }); }
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save(); ctx.scale(scaleX, scaleY);
            stars.forEach(s => { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
            particles.forEach(p => { ctx.fillStyle = p.color; ctx.globalAlpha = p.life; ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill(); });
            bullets.forEach(b => { ctx.fillStyle = '#FF00FF'; ctx.beginPath(); ctx.arc(b.x, b.y, 8, 0, Math.PI*2); ctx.fill(); });
            ctx.restore();
            if (gameStarted) { drawPlayer(); enemies.forEach(drawEnemy); if (bossActive) drawBoss(); }
        }

        function gameLoop(t) {
            const dt = (t - lastTime) / 1000; lastTime = t;
            if (gameStarted && !gamePaused) {
                if (t > nextSpawnTime && !bossActive) { createEnemy(); nextSpawnTime = t + Math.max(400, 1200 - level * 60); }
                update(dt);
            }
            draw(); requestAnimationFrame(gameLoop);
        }

        // --- INTERACTIONS ---
        function checkHit(x, y) {
            if (bossActive && boss) {
                if (Math.hypot(x - boss.x, y - boss.y) < boss.size/2) {
                    boss.health -= superClick ? 2 : 1;
                    if (boss.health <= 0) { bossActive = false; score += 1000 * multiplier; updateScore(); }
                    return;
                }
            }
            for (let i = enemies.length - 1; i >= 0; i--) {
                let e = enemies[i];
                if (Math.hypot(x - e.x, y - e.y) < e.size/2) {
                    e.health -= superClick ? 2 : 1;
                    if (e.health <= 0) { score += (10 + level * 5) * multiplier; enemies.splice(i, 1); updateScore(); }
                    break;
                }
            }
        }

        canvas.addEventListener('mousedown', e => { const r = canvas.getBoundingClientRect(); checkHit((e.clientX - r.left)/scaleX, (e.clientY - r.top)/scaleY); });
        canvas.addEventListener('touchstart', e => {
            e.preventDefault(); const r = canvas.getBoundingClientRect();
            for (let t of e.touches) {
                const x = (t.clientX - r.left)/scaleX, y = (t.clientY - r.top)/scaleY;
                checkHit(x, y);
                if (t.clientX < window.innerWidth / 2) {
                    joystickActive = true; joystickTouchId = t.identifier; joystickCenterX = t.clientX; joystickCenterY = t.clientY;
                    joystickEl.style.display = 'block'; joystickEl.style.left = `${t.clientX - 50}px`; joystickEl.style.top = `${t.clientY - 50}px`;
                }
            }
        });

        document.addEventListener('touchmove', e => {
            if (!joystickActive) return;
            for (let t of e.touches) {
                if (t.identifier === joystickTouchId) {
                    let dx = t.clientX - joystickCenterX, dy = t.clientY - joystickCenterY;
                    const d = Math.hypot(dx, dy); if (d > 50) { dx *= 50/d; dy *= 50/d; }
                    joystickKnob.style.left = `calc(50% + ${dx}px)`; joystickKnob.style.top = `calc(50% + ${dy}px)`;
                    player.x += dx/50 * playerSpeed; player.y += dy/50 * playerSpeed;
                    player.x = Math.max(30, Math.min(770, player.x)); player.y = Math.max(30, Math.min(570, player.y));
                }
            }
        });
        document.addEventListener('touchend', () => { joystickActive = false; joystickEl.style.display = 'none'; });

        // --- UI & TON ---
        document.getElementById('start-button').onclick = () => {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('ui').style.display = 'flex';
            gameStarted = true; lastTime = performance.now();
        };

        document.getElementById('shop-button').onclick = () => { gamePaused = true; shopEl.style.display = 'block'; };
        document.getElementById('close-shop').onclick = () => { gamePaused = false; shopEl.style.display = 'none'; };
        document.getElementById('restart-button').onclick = () => location.reload();

        function updateScore() { scoreEl.textContent = `Score: ${Math.floor(score)}`; if (Math.floor(score/500)+1 > level) { level = Math.floor(score/500)+1; levelEl.textContent = `Level: ${level}`; if (level % 3 === 0) createBoss(); } }
        function updateHealth() { healthEl.textContent = `Health: ${health}`; if (health <= 0) { gameStarted = false; document.getElementById('game-over').style.display = 'flex'; document.getElementById('final-score').textContent = Math.floor(score); } }

        // Shop Logic
        document.getElementById('buy-auto').onclick = () => { if(score >= 50) { score -= 50; autoClickers++; updateScore(); } };
        document.getElementById('buy-multi').onclick = () => { if(score >= 100) { score -= 100; multiplier *= 2; updateScore(); } };
        document.getElementById('buy-super').onclick = () => { if(score >= 200) { score -= 200; superClick = true; updateScore(); } };
        document.getElementById('buy-speed').onclick = () => { if(score >= 150) { score -= 150; playerSpeed *= 1.2; updateScore(); } };
        document.getElementById('buy-health').onclick = () => { if(score >= 300) { score -= 300; health++; updateHealth(); updateScore(); } };
        document.getElementById('buy-magnet').onclick = () => { if(score >= 250) { score -= 250; magnet = true; updateScore(); } };

        async function buyWithTon(amount, action) {
            try {
                const tx = { validUntil: Math.floor(Date.now()/1000)+60, messages: [{ address: devWallet, amount: (amount*1e9).toString() }] };
                await tonConnectUI.sendTransaction(tx); action(); telegram.showAlert('Acquisto completato!');
            } catch(e) { telegram.showAlert('Errore: ' + e.message); }
        }
        document.getElementById('buy-auto-ton').onclick = () => buyWithTon(0.1, () => { autoClickers++; updateScore(); });
        document.getElementById('buy-multi-ton').onclick = () => buyWithTon(0.2, () => { multiplier *= 2; updateScore(); });
        document.getElementById('buy-super-ton').onclick = () => buyWithTon(0.5, () => { superClick = true; updateScore(); });
        document.getElementById('buy-speed-ton').onclick = () => buyWithTon(0.3, () => { playerSpeed *= 1.2; updateScore(); });
        document.getElementById('buy-health-ton').onclick = () => buyWithTon(0.6, () => { health++; updateHealth(); });
        document.getElementById('buy-magnet-ton').onclick = () => buyWithTon(0.5, () => { magnet = true; updateScore(); });

        setInterval(() => { if(gameStarted && !gamePaused) { score += autoClickers * multiplier; updateScore(); } }, 1000);
        init();
    </script>
</body>
</html>
