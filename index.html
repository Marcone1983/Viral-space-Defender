<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viral Space Defender - Enterprise Edition</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon-512.svg">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; color: #FFD700; }
        #game-container { position: relative; width: 800px; height: 600px; background: #000; border: 5px solid #00FFFF; border-radius: 15px; box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); overflow: hidden; }
        #canvas { display: block; background: transparent; }
        #title-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #start-button { background: #FF00FF; color: #fff; padding: 15px 30px; border: none; border-radius: 10px; cursor: pointer; font-size: 24px; margin-top: 20px; z-index: 110; }
        #ui { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 20px; font-weight: bold; z-index: 50; pointer-events: none; }
        #ui > * { pointer-events: auto; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; }
        #shop-button { background: #FF4500; color: white; border: none; cursor: pointer; }
        #ton-connect-wrapper { position: absolute; top: 60px; right: 10px; z-index: 150; display: flex; flex-direction: column; align-items: flex-end; gap: 5px; }
        #connect-wallet-btn { background: linear-gradient(135deg, #0098EA, #00D4FF); color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #skills-ui { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 60; }
        .skill-slot { width: 60px; height: 60px; background: rgba(0,0,0,0.7); border: 2px solid #00FFFF; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; position: relative; }
        .skill-key { font-size: 10px; color: #FFD700; position: absolute; top: 2px; left: 4px; }
        .skill-icon { font-size: 24px; }
        #shop { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); padding: 20px; border-radius: 15px; border: 2px solid #00FFFF; display: none; z-index: 200; width: 400px; }
        .shop-item { display: flex; justify-content: space-between; align-items: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        #game-over { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,0,0,0.7); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 300; color: #fff; }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas" width="800" height="600"></canvas>
        <div id="title-screen">
            <h1 style="font-size: 48px; text-shadow: 0 0 20px #00FFFF;">VIRAL SPACE DEFENDER</h1>
            <button id="start-button">START MISSION</button>
        </div>
        <div id="ui" style="display: none;">
            <div id="score">Score: 0</div>
            <div id="level">Level: 1</div>
            <div id="health">Health: 3</div>
            <button id="shop-button">UPGRADES</button>
        </div>
        <div id="ton-connect-wrapper">
            <button id="connect-wallet-btn">CONNECT WALLET</button>
            <div id="wallet-status" style="display:none;">DISCONNECTED</div>
        </div>
        <div id="skills-ui" style="display: none;">
            <div class="skill-slot" onclick="useSkill(0)"><span class="skill-key">1</span><span class="skill-icon">üõ°Ô∏è</span></div>
            <div class="skill-slot" onclick="useSkill(1)"><span class="skill-key">2</span><span class="skill-icon">‚ö°</span></div>
            <div class="skill-slot" onclick="useSkill(2)"><span class="skill-key">3</span><span class="skill-icon">üöÄ</span></div>
        </div>
        <div id="shop">
            <h2>UPGRADE STATION</h2>
            <div class="shop-item"><span>Auto-Blaster</span><button onclick="buy(50)">50 pts</button></div>
            <button id="close-shop" style="width:100%; margin-top:10px;">EXIT</button>
        </div>
        <div id="game-over">
            <h1>MISSION FAILED</h1>
            <button onclick="location.reload()">RETRY</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const GameState = { score: 0, level: 1, health: 3, gameStarted: false, gamePaused: false, multiplier: 1, devWallet: 'UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR' };
        let player = { x: 400, y: 500, size: 40, shield: false };
        let enemies = [], bullets = [], stars = [], particles = [], lastTime = 0, nextSpawn = 0;

        // TON Connect
        const tonConnectUI = new TONCONNECT_UI.TonConnectUI({ manifestUrl: 'https://viral-space-defender.vercel.app/tonconnect-manifest.json' });
        tonConnectUI.onStatusChange(wallet => {
            const btn = document.getElementById('connect-wallet-btn');
            btn.textContent = wallet ? 'WALLET ‚úì' : 'CONNECT WALLET';
            btn.style.background = wallet ? '#32CD32' : 'linear-gradient(135deg, #0098EA, #00D4FF)';
        });

        document.getElementById('connect-wallet-btn').onclick = () => tonConnectUI.connected ? tonConnectUI.disconnect() : tonConnectUI.openModal();
        document.getElementById('start-button').onclick = () => {
            document.getElementById('title-screen').style.display = 'none';
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('skills-ui').style.display = 'flex';
            GameState.gameStarted = true;
            nextSpawn = Date.now() + 1000;
            requestAnimationFrame(gameLoop);
        };

        function spawnEnemy() {
            enemies.push({ x: Math.random() * 750 + 25, y: -50, size: 30, speed: 2 + GameState.level * 0.5, hp: 1 });
        }

        function update(dt) {
            if (!GameState.gameStarted || GameState.gamePaused) return;
            
            // Spawn logic
            if (Date.now() > nextSpawn) {
                spawnEnemy();
                nextSpawn = Date.now() + Math.max(500, 1500 - GameState.level * 100);
            }

            enemies.forEach((e, i) => {
                e.y += e.speed;
                if (e.y > 650) { enemies.splice(i, 1); GameState.health--; }
                if (Math.hypot(player.x - e.x, player.y - e.y) < 35) { enemies.splice(i, 1); GameState.health--; }
            });

            bullets.forEach((b, i) => {
                b.y -= 10;
                if (b.y < 0) bullets.splice(i, 1);
                enemies.forEach((e, j) => {
                    if (Math.hypot(b.x - e.x, b.y - e.y) < 25) {
                        enemies.splice(j, 1); bullets.splice(i, 1);
                        GameState.score += 10;
                    }
                });
            });

            if (GameState.health <= 0) { GameState.gameStarted = false; document.getElementById('game-over').style.display = 'flex'; }
            document.getElementById('score').textContent = `Score: ${GameState.score}`;
            document.getElementById('health').textContent = `Health: ${GameState.health}`;
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 800, 600);
            
            // Stars
            ctx.fillStyle = '#fff';
            if (stars.length === 0) for(let i=0; i<50; i++) stars.push({x:Math.random()*800, y:Math.random()*600});
            stars.forEach(s => { s.y += 1; if(s.y > 600) s.y = 0; ctx.fillRect(s.x, s.y, 2, 2); });

            if (GameState.gameStarted) {
                // Player
                ctx.fillStyle = '#00FFFF'; ctx.beginPath(); ctx.arc(player.x, player.y, 20, 0, Math.PI*2); ctx.fill();
                // Enemies
                enemies.forEach(e => { ctx.fillStyle = '#FF0000'; ctx.fillRect(e.x-15, e.y-15, 30, 30); });
                // Bullets
                bullets.forEach(b => { ctx.fillStyle = '#FFFF00'; ctx.fillRect(b.x-2, b.y-10, 4, 20); });
            }
        }

        function gameLoop(t) {
            const dt = (t - lastTime) / 1000; lastTime = t;
            update(dt); draw();
            if (GameState.gameStarted) requestAnimationFrame(gameLoop);
        }

        window.onkeydown = e => {
            if (e.key === 'ArrowLeft') player.x -= 20;
            if (e.key === 'ArrowRight') player.x += 20;
            if (e.key === ' ') bullets.push({x: player.x, y: player.y});
            player.x = Math.max(20, Math.min(780, player.x));
        };
        
        function useSkill(n) { console.log('Skill', n); }
        document.getElementById('shop-button').onclick = () => { GameState.gamePaused = true; document.getElementById('shop').style.display = 'block'; };
        document.getElementById('close-shop').onclick = () => { GameState.gamePaused = false; document.getElementById('shop').style.display = 'none'; };
    </script>
</body>
</html>
