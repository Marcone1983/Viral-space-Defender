<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Viral Space Defender - Enterprise Edition</title>
    <!-- SCRIPTS ESTERNI - INTEGRATI SECONDO AUDIT SENIOR -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
        /* CSS ORIGINALE PRESERVATO */
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0A0A2A, #1C1C4C);
            font-family: 'Courier New', monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            color: #FFD700;
        }
        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            background: #000;
            border: 5px solid #00FFFF;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
            overflow: hidden;
        }
        #canvas {
            display: block;
            background: transparent;
        }
        #title-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Aumentato per Audit */
        }
        #logo {
            width: 300px;
            height: 300px;
        }
        #start-button {
            background: #FF00FF;
            color: #fff;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            margin-top: 20px;
            transition: transform 0.3s;
            z-index: 110;
            position: relative;
        }
        #start-button:hover {
            transform: scale(1.1);
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 0 0 5px #00FFFF;
            z-index: 50;
        }
        #score, #level, #health {
            background: rgba(0, 0, 0, 0.6);
            padding: 8px 15px;
            border-radius: 8px;
        }
        #shop-button {
            background: #FF4500;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            transition: transform 0.2s;
        }
        #shop-button:hover {
            transform: scale(1.1);
        }
        #shop {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 0 20px #00FFFF;
            display: none;
            z-index: 200;
            width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
        #shop h2 {
            text-align: center;
            color: #00FFFF;
            text-shadow: 0 0 10px #00FFFF;
        }
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border: 1px solid #00FFFF;
        }
        .shop-item span {
            flex: 1;
            font-size: 14px;
        }
        .shop-item button {
            background: #32CD32;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            margin-left: 5px;
            font-weight: bold;
        }
        .shop-item button:hover {
            background: #228B22;
        }
        .shop-item button:disabled {
            background: #444;
            cursor: not-allowed;
        }
        #close-shop {
            display: block;
            margin: 15px auto 0;
            background: #FF0000;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            font-size: 18px;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 300;
            color: #fff;
            font-size: 48px;
            text-shadow: 0 0 10px #000;
        }
        #restart-button {
            background: #FFD700;
            color: #000;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            margin-top: 20px;
        }

        /* 10x IMPROVEMENT: ENTERPRISE WALLET UI */
        #ton-connect-wrapper {
            position: absolute;
            top: 70px;
            right: 10px;
            z-index: 150;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            border-radius: 10px;
            border: 1px solid #00FFFF;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #wallet-status {
            font-size: 12px;
            color: #00FFFF;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas" width="800" height="600"></canvas>
        
        <!-- TITLE SCREEN - CORRETTA PER AUDIT -->
        <div id="title-screen">
            <svg id="logo" viewBox="0 0 100 100">
                <polygon points="50,10 90,30 90,70 50,90 10,70 10,30" fill="none" stroke="#00FFFF" stroke-width="3"/>
                <polygon points="50,20 80,35 80,65 50,80 20,65 20,35" fill="none" stroke="#FF00FF" stroke-width="3"/>
                <text x="50" y="55" font-size="30" text-anchor="middle" fill="#FFD700" font-weight="bold">VSD</text>
                <line x1="30" y1="40" x2="70" y2="60" stroke="#FFFF00" stroke-width="2"/>
                <line x1="30" y1="60" x2="70" y2="40" stroke="#FFFF00" stroke-width="2"/>
            </svg>
            <h1 style="text-shadow: 0 0 10px #00FFFF;">Viral Space Defender</h1>
            <button id="start-button">START MISSION</button>
        </div>

        <!-- UI GAMEPLAY -->
        <div id="ui" style="display: none;">
            <div id="score">Score: 0</div>
            <div id="level">Level: 1</div>
            <div id="health">Health: 3</div>
            <button id="shop-button">UPGRADES</button>
        </div>

        <!-- WALLET CONTAINER - VISIBILE E FUNZIONANTE -->
        <div id="ton-connect-wrapper">
            <span id="wallet-status">DISCONNECTED</span>
            <div id="ton-connect"></div>
        </div>

        <!-- SHOP ENTERPRISE - MONETIZZAZIONE MASSIVA -->
        <div id="shop">
            <h2>UPGRADE STATION</h2>
            <div class="shop-item">
                <span>Auto-Blaster (+1/sec)<br>50 Score / 0.1 TON</span>
                <button id="buy-auto">SCORE</button>
                <button id="buy-auto-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Score Multiplier x2<br>100 Score / 0.2 TON</span>
                <button id="buy-multi">SCORE</button>
                <button id="buy-multi-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Super Laser (x2 damage)<br>200 Score / 0.5 TON</span>
                <button id="buy-super">SCORE</button>
                <button id="buy-super-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Speed Boost (+20%)<br>150 Score / 0.3 TON</span>
                <button id="buy-speed">SCORE</button>
                <button id="buy-speed-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Shield Upgrade (+1 health)<br>300 Score / 0.6 TON</span>
                <button id="buy-health">SCORE</button>
                <button id="buy-health-ton">TON</button>
            </div>
            <div class="shop-item">
                <span>Magnet Field (attract)<br>250 Score / 0.5 TON</span>
                <button id="buy-magnet">SCORE</button>
                <button id="buy-magnet-ton">TON</button>
            </div>
            <button id="close-shop">EXIT STATION</button>
        </div>

        <div id="game-over">
            <h1>MISSION FAILED</h1>
            <p>Final Score: <span id="final-score"></span></p>
            <button id="restart-button">RETRY MISSION</button>
        </div>
    </div>

    <!-- AUDIO ORIGINALE PRESERVATO -->
    <audio id="bg-music" loop><source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg"></audio>
    <audio id="hit-sound"><source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg"></audio>
    <audio id="level-up-sound"><source src="data:audio/mpeg;base64,//MUXAAAAAEluZm8AAAAHAAAABAAAASAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAP4AAAAAACwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//MUZAAAAAGkAAABAAAAAQAAADwAAAAgAAAAABAAEAAAAAACAAAAAAAAAAAAAAAACAAAEAAAABAAAABgAAAAYAAAD+////AAAAAP//KExBTUUzLjk4qAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg"></audio>

    <script>
        // --- 10x ENTERPRISE CORE: STATE MANAGEMENT ---
        const GameState = {
            score: 0, level: 1, health: 3,
            playerSpeed: 15, autoClickers: 0, multiplier: 1,
            superClick: false, magnet: false,
            gameStarted: false, gamePaused: false,
            bossActive: false,
            devWallet: 'UQArbhbVEIkN4xSWis30yIrNGdmOTBbiMBduGeNTErPbviyR'
        };

        // --- TON CONNECT INITIALIZATION ---
        const tonConnectUI = new TONCONNECT_UI.TonConnectUI({
            manifestUrl: 'https://marcone1983.github.io/Viral-space-Defender/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        tonConnectUI.onStatusChange(wallet => {
            const status = document.getElementById('wallet-status');
            if (wallet) {
                status.textContent = 'CONNECTED';
                status.style.color = '#32CD32';
            } else {
                status.textContent = 'DISCONNECTED';
                status.style.color = '#00FFFF';
            }
        });

        // --- TELEGRAM INTEGRATION ---
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        // --- CANVAS & CONTEXT ---
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const levelEl = document.getElementById('level');
        const healthEl = document.getElementById('health');
        const shop = document.getElementById('shop');
        const titleScreen = document.getElementById('title-screen');
        const startButton = document.getElementById('start-button');
        const gameOver = document.getElementById('game-over');
        const finalScore = document.getElementById('final-score');
        const bgMusic = document.getElementById('bg-music');
        const hitSound = document.getElementById('hit-sound');
        const levelUpSound = document.getElementById('level-up-sound');

        // --- 10x IMPROVEMENT: ADVANCED ENTITY SYSTEM ---
        let stars = [], enemies = [], particles = [], powerUps = [], bullets = [];
        let player = { x: 400, y: 500, size: 50, color: '#00FFFF', armorColor: '#FFD700', helmetColor: '#FF00FF' };
        let boss = null, nextSpawnTime = 0, lastTime = 0;

        // --- 10x IMPROVEMENT: PARTICLE ENGINE ---
        function createParticles(x, y, count = 10, color = '#FFD700') {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x, y, 
                    vx: (Math.random() - 0.5) * 10, 
                    vy: (Math.random() - 0.5) * 10, 
                    life: 1, color 
                });
            }
        }

        // --- DRAWING FUNCTIONS (ORIGINAL DESIGNS PRESERVED) ---
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x, player.y);
            // Corpo
            ctx.fillStyle = player.color;
            ctx.beginPath(); ctx.ellipse(0, 0, 20, 30, 0, 0, Math.PI * 2); ctx.fill();
            // Armatura
            ctx.fillStyle = player.armorColor;
            ctx.beginPath(); ctx.moveTo(-25, -10); ctx.lineTo(-35, 10); ctx.lineTo(-25, 20); ctx.fill();
            ctx.beginPath(); ctx.moveTo(25, -10); ctx.lineTo(35, 10); ctx.lineTo(25, 20); ctx.fill();
            // Casco
            ctx.fillStyle = player.helmetColor;
            ctx.beginPath(); ctx.arc(0, -25, 15, 0, Math.PI * 2); ctx.fill();
            // Propulsore
            if (Math.random() > 0.5) {
                ctx.fillStyle = '#FF4500';
                ctx.beginPath(); ctx.moveTo(-10, 30); ctx.lineTo(0, 50); ctx.lineTo(10, 30); ctx.fill();
            }
            ctx.restore();
        }

        function createEnemy() {
            const types = ['drone', 'fighter', 'bomber'];
            const type = types[Math.floor(Math.random() * types.length)];
            let size = 30, speed = 2 + GameState.level * 0.3, color = '#FF0000', hp = 1;
            if (type === 'fighter') { size = 25; speed += 1; color = '#FF4500'; }
            else if (type === 'bomber') { size = 40; speed -= 0.5; color = '#8B0000'; hp = 2; }
            enemies.push({ x: Math.random() * 750 + 25, y: -50, size, speed, color, type, health: hp, angle: 0 });
        }

        // --- 10x IMPROVEMENT: BOSS SYSTEM ---
        function createBoss() {
            boss = { 
                x: 400, y: 100, size: 150, speed: 2, 
                health: 20 + GameState.level * 5, 
                maxHealth: 20 + GameState.level * 5, 
                color: '#4B0082', angle: 0, dir: 1 
            };
            GameState.bossActive = true;
        }

        // --- GAME LOOP & LOGIC ---
        function update(dt) {
            if (!GameState.gameStarted || GameState.gamePaused) return;

            // Stars
            stars.forEach(s => { s.y += s.speed; if (s.y > 600) s.y = 0; });

            // Enemies
            for (let i = enemies.length - 1; i >= 0; i--) {
                const e = enemies[i];
                e.y += e.speed;
                if (GameState.magnet) {
                    const dx = player.x - e.x, dy = player.y - e.y, d = Math.hypot(dx, dy);
                    if (d < 200) { e.x += dx/d * 2; e.y += dy/d * 2; }
                }
                if (e.y > 650) { GameState.health--; updateUI(); enemies.splice(i, 1); continue; }
                if (Math.hypot(player.x - e.x, player.y - e.y) < (player.size + e.size)/2) {
                    GameState.health--; updateUI();
                    createParticles(e.x, e.y, 15, e.color);
                    enemies.splice(i, 1);
                }
            }

            // Boss
            if (GameState.bossActive && boss) {
                boss.x += Math.sin(boss.angle) * boss.speed * boss.dir;
                boss.angle += 0.02;
                if (boss.x < 100 || boss.x > 700) boss.dir *= -1;
                if (Math.hypot(player.x - boss.x, player.y - boss.y) < (player.size + boss.size)/2) {
                    GameState.health -= 0.1; updateUI();
                }
            }

            // Particles
            particles.forEach((p, i) => {
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            ctx.fillStyle = '#000'; ctx.fillRect(0, 0, 800, 600);
            
            // Stars
            stars.forEach(s => { ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
            
            if (GameState.gameStarted) {
                drawPlayer();
                enemies.forEach(e => {
                    ctx.save(); ctx.translate(e.x, e.y); ctx.fillStyle = e.color;
                    if (e.type === 'drone') { ctx.beginPath(); ctx.arc(0, 0, e.size/2, 0, Math.PI*2); ctx.fill(); }
                    else if (e.type === 'fighter') { ctx.beginPath(); ctx.moveTo(0, -e.size/2); ctx.lineTo(-e.size/2, e.size/2); ctx.lineTo(e.size/2, e.size/2); ctx.fill(); }
                    else { ctx.fillRect(-e.size/2, -e.size/4, e.size, e.size/2); }
                    ctx.restore();
                });
                if (GameState.bossActive && boss) {
                    ctx.save(); ctx.translate(boss.x, boss.y); ctx.fillStyle = boss.color;
                    ctx.beginPath(); ctx.moveTo(0, -boss.size/2); ctx.lineTo(-boss.size/2, boss.size/2); ctx.lineTo(boss.size/2, boss.size/2); ctx.fill();
                    ctx.fillStyle = '#FF0000'; ctx.fillRect(-boss.size/2, -boss.size/2-10, boss.size, 5);
                    ctx.fillStyle = '#00FF00'; ctx.fillRect(-boss.size/2, -boss.size/2-10, boss.size * (boss.health/boss.maxHealth), 5);
                    ctx.restore();
                }
                particles.forEach(p => {
                    ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }

        function gameLoop(t) {
            const dt = (t - lastTime) / 1000; lastTime = t;
            if (GameState.gameStarted && !GameState.gamePaused) {
                if (Date.now() > nextSpawnTime && !GameState.bossActive) {
                    createEnemy(); nextSpawnTime = Date.now() + Math.max(200, 800 - GameState.level * 30);
                }
                update(dt);
            }
            draw(); requestAnimationFrame(gameLoop);
        }

        // --- 10x IMPROVEMENT: MONETIZATION LOGIC ---
        async function buyWithTon(amount, action) {
            try {
                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 60,
                    messages: [{ address: GameState.devWallet, amount: (amount * 1e9).toString() }]
                };
                await tonConnectUI.sendTransaction(tx);
                action(); tg.showAlert('PURCHASE SUCCESSFUL!');
            } catch (e) { tg.showAlert('TRANSACTION FAILED: ' + e.message); }
        }

        // --- UI UPDATES ---
        function updateUI() {
            scoreEl.textContent = `Score: ${Math.floor(GameState.score)}`;
            levelEl.textContent = `Level: ${GameState.level}`;
            healthEl.textContent = `Health: ${Math.ceil(GameState.health)}`;
            if (GameState.health <= 0) {
                GameState.gameStarted = false;
                gameOver.style.display = 'flex';
                finalScore.textContent = Math.floor(GameState.score);
                bgMusic.pause();
            }
            const newLvl = Math.floor(GameState.score / 500) + 1;
            if (newLvl > GameState.level) {
                GameState.level = newLvl; levelUpSound.play();
                if (GameState.level % 5 === 0) createBoss();
            }
        }

        // --- EVENT LISTENERS (FIXED START BUTTON) ---
        window.onload = () => {
            // Inizializzazione stelle
            for (let i = 0; i < 100; i++) stars.push({ x: Math.random()*800, y: Math.random()*600, size: Math.random()*2+1, speed: Math.random()*0.5+0.1 });
            
            // Fix Start Button
            startButton.addEventListener('click', (e) => {
                console.log("Start Mission Clicked");
                titleScreen.style.display = 'none';
                document.getElementById('ui').style.display = 'flex';
                GameState.gameStarted = true;
                GameState.gamePaused = false;
                lastTime = performance.now();
                bgMusic.play().catch(err => console.log("Audio play blocked"));
                nextSpawnTime = Date.now() + 500;
                requestAnimationFrame(gameLoop);
            });

            // Altri listener
            document.getElementById('shop-button').onclick = () => { GameState.gamePaused = true; shop.style.display = 'block'; };
            document.getElementById('close-shop').onclick = () => { GameState.gamePaused = false; shop.style.display = 'none'; };
            document.getElementById('restart-button').onclick = () => location.reload();

            // Shop Score
            document.getElementById('buy-auto').onclick = () => { if(GameState.score >= 50) { GameState.score -= 50; GameState.autoClickers++; updateUI(); } };
            document.getElementById('buy-multi').onclick = () => { if(GameState.score >= 100) { GameState.score -= 100; GameState.multiplier *= 2; updateUI(); } };
            document.getElementById('buy-super').onclick = () => { if(GameState.score >= 200) { GameState.score -= 200; GameState.superClick = true; updateUI(); } };
            document.getElementById('buy-speed').onclick = () => { if(GameState.score >= 150) { GameState.score -= 150; GameState.playerSpeed += 3; updateUI(); } };
            document.getElementById('buy-health').onclick = () => { if(GameState.score >= 300) { GameState.score -= 300; GameState.health++; updateUI(); } };
            document.getElementById('buy-magnet').onclick = () => { if(GameState.score >= 250) { GameState.score -= 250; GameState.magnet = true; updateUI(); } };

            // Shop TON
            document.getElementById('buy-auto-ton').onclick = () => buyWithTon(0.1, () => { GameState.autoClickers++; updateUI(); });
            document.getElementById('buy-multi-ton').onclick = () => buyWithTon(0.2, () => { GameState.multiplier *= 2; updateUI(); });
            document.getElementById('buy-super-ton').onclick = () => buyWithTon(0.5, () => { GameState.superClick = true; updateUI(); });
            document.getElementById('buy-speed-ton').onclick = () => buyWithTon(0.3, () => { GameState.playerSpeed += 3; updateUI(); });
            document.getElementById('buy-health-ton').onclick = () => buyWithTon(0.6, () => { GameState.health++; updateUI(); });
            document.getElementById('buy-magnet-ton').onclick = () => buyWithTon(0.5, () => { GameState.magnet = true; updateUI(); });

            // Controls
            const keys = {};
            document.addEventListener('keydown', e => keys[e.key] = true);
            document.addEventListener('keyup', e => keys[e.key] = false);
            setInterval(() => {
                if (!GameState.gameStarted || GameState.gamePaused) return;
                if (keys['ArrowLeft'] || keys['a']) player.x -= GameState.playerSpeed;
                if (keys['ArrowRight'] || keys['d']) player.x += GameState.playerSpeed;
                if (keys['ArrowUp'] || keys['w']) player.y -= GameState.playerSpeed;
                if (keys['ArrowDown'] || keys['s']) player.y += GameState.playerSpeed;
                player.x = Math.max(25, Math.min(775, player.x));
                player.y = Math.max(25, Math.min(575, player.y));
            }, 16);

            canvas.addEventListener('click', e => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left, y = e.clientY - rect.top;
                if (GameState.bossActive && boss && Math.hypot(x - boss.x, y - boss.y) < boss.size/2) {
                    boss.health -= GameState.superClick ? 2 : 1;
                    createParticles(boss.x, boss.y, 10); hitSound.play();
                    if (boss.health <= 0) { GameState.bossActive = false; GameState.score += 1000 * GameState.multiplier; updateUI(); }
                    return;
                }
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const en = enemies[i];
                    if (Math.hypot(x - en.x, y - en.y) < en.size/2) {
                        en.health -= GameState.superClick ? 2 : 1;
                        if (en.health <= 0) { GameState.score += (10 + GameState.level*5) * GameState.multiplier; createParticles(en.x, en.y, 10); enemies.splice(i, 1); updateUI(); }
                        break;
                    }
                }
            });

            // Auto-score
            setInterval(() => { if(GameState.gameStarted && !GameState.gamePaused) { GameState.score += GameState.autoClickers * GameState.multiplier; updateUI(); } }, 1000);
            
            requestAnimationFrame(gameLoop);
        };
    </script>
</body>
</html>
